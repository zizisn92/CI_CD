# CÁN BỘ
packge-and-publish:
  stage: packge-and-publish
  extends:
    - .image-base-angular
  rules:
    - if: '$CI_COMMIT_BRANCH != "dev"' 
      when: never
    - if: '$CI_COMMIT_MESSAGE !~ /(\[library\])/'
      when: never
    - if: '$CI_COMMIT_MESSAGE !~ /(\[library\]|\[$MODULE_NAME\])/'
      when: never
    - when: always
  script:
    - cd $APP_PATH
    - git config --global http.sslVerify false
    - rm -rf $COMMON_WORKSPACE_NAME
    - if ! [ -d "$COMMON_WORKSPACE_NAME" ]; then git clone https://gitlab-ci-token:${CI_JOB_TOKEN}@git.dttt.vn/gitadmin/$COMMON_WORKSPACE_NAME; fi
    - cd $COMMON_WORKSPACE_NAME
    - git checkout dev
    - git pull
    - cd ..
    - npm install
    - npm run generate-all-ci
    - npm config set _auth $NPM_AUTH
    - npm run package-$MODULE_NAME-service
build:
  stage: packge-and-publish
  extends:
    - .image-base-angular
  rules:
    # - if: '$CI_COMMIT_BRANCH != "dev"'
    # - if: '$CI_COMMIT_BRANCH != "hotfix/sua-loi-build-canbo-client"'
    #   when: never
    - if: '$CI_COMMIT_BRANCH != "dev"'
      when: never
    # - if: '$CI_COMMIT_MESSAGE !~ /(\[app\])/ || $CI_COMMIT_MESSAGE !~ /(\[all\])'
    #   when: never
    - if: '$CI_COMMIT_MESSAGE !~ /(\[app\])/'
      when: never
    # - if: '$CI_COMMIT_MESSAGE !~ /(\[app\]|\[$MODULE_NAME\])/'
    #   when: never
    - when: always
  script:
    - cd $APP_PATH
    - git config --global http.sslVerify false
    - rm -rf $COMMON_WORKSPACE_NAME
    - if ! [ -d "$COMMON_WORKSPACE_NAME" ]; then git clone https://gitlab-ci-token:${CI_JOB_TOKEN}@git.dttt.vn/gitadmin/$COMMON_WORKSPACE_NAME; fi
    - cd $COMMON_WORKSPACE_NAME
    - git checkout dev
    - git pull
    - cd ..
    - npm install
    # workaround: Khôi phục lại file environment.prod.ts bị thay đổi nội dung sau khi chạy generate-all-ci
    # - cp node_modules/tnx-shared/assets/docker/* gitlab-environment
    # - cd gitlab-environment
    # - ls
    # - git config --global user.email "hungnx@trinam.vn"
    # - git checkout dev
    # - git pull
    # - git add .
    # - git commit -m 'add dockerfile and deploy client.ci'
    # - git push 'http://gitlab-ci-token${CI_JOB_TOKEN}@git.dttt.vn/gitadmin/canbo.git'
    # - cd ..
    - cp $COMMON_WORKSPACE_NAME/App/shared/environments/environment.prod.ts $COMMON_WORKSPACE_NAME/App/shared/environments/environment.prod.ts.bak
    - npm run generate-all-ci
    - cp $COMMON_WORKSPACE_NAME/App/shared/environments/environment.prod.ts.bak $COMMON_WORKSPACE_NAME/App/shared/environments/environment.prod.ts
    - npm run build-$MODULE_NAME-ci
  artifacts:
    paths:
      - $APP_PATH/dist/
      - $APP_PATH/node_modules/tnx-shared/assets/docker/
    expire_in: 1 hour    

docker-build-client:
  stage: docker-build-client
  extends:
    - .image-docker-with-bash
  needs:
    - build
  rules:
    - if: '$CI_COMMIT_BRANCH != "dev"'
      when: never
    # - if: '$CI_COMMIT_MESSAGE !~ /(\[app\]|\[all\])/'
    #   when: never
    # - if: '$CI_COMMIT_MESSAGE !~ /(\[app\]|\[$MODULE_NAME\])/'
    #   when: never
    - if: '$CI_COMMIT_MESSAGE !~ /(\[app\])/'
      when: never
    - when: always
  script:
    - chmod -R 777 $APP_PATH
    - cd $APP_PATH
    - git config --global http.sslVerify false
    - git clone https://gitlab-ci-token:${CI_JOB_TOKEN}@git.dttt.vn/gitadmin/gitlabutils
    #- cd gitlabutils/gitlab-environment
    - cd ..
    - cp $APP_PATH/gitlabutils/gitlab-environment/* $APP_PATH
    - cd $APP_PATH
    # - cd $APP_PATH/node_modules/tnx-shared/assets/docker
    # - dos2unix deploy.client.ci
    - "bash deploy.client.ci -a $MODULE_NAME -e $CI_COMMIT_BRANCH -scope business -imageSuffix .client -tagOnly false -b $TARGET_ENVIRONMENT_BUILD"
    # mặc định bản build là /business, sau này sẽ tách thành các khách hàng riêng sẽ replace bằng param --fromEnvironment business  
    # "bash deploy.client.ci -a $MODULE_NAME -e $CI_COMMIT_BRANCH -scope business -imageSuffix .client -tagOnly false"